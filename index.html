<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria de V√≠deos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            padding: 20px;
            padding-bottom: 100px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-section {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #ddd;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f0f0;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-weight: 600;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        #fileInput {
            display: none;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .video-item {
            background: #f9f9f9;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease;
            position: relative;
            border: 1px solid #e0e0e0;
        }

        .video-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .video-item.has-sound {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.6);
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 59, 48, 0.9);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .delete-btn:hover {
            background: rgba(255, 59, 48, 1);
            transform: scale(1.1);
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 177.78%; /* 9:16 aspect ratio */
            background: #000;
        }

        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
        }

        .sound-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
        }

        .video-item.has-sound .sound-icon {
            opacity: 1;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .video-item:hover .video-overlay {
            opacity: 1;
        }

        .video-item.playing .video-overlay {
            opacity: 0;
        }

        .play-icon {
            width: 0;
            height: 0;
            border-left: 30px solid white;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
            opacity: 0.9;
        }

        .video-info {
            padding: 15px;
            background: #f0f0f0;
        }

        .video-name {
            font-size: 0.9rem;
            color: #555;
            word-break: break-word;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .video-name:hover {
            color: #667eea;
            text-decoration: underline;
        }

        /* Speed Controls */
        .speed-controls {
            position: fixed;
            bottom: 30px;
            left: 30px;
            display: flex;
            gap: 8px;
            z-index: 1000;
            flex-direction: column;
            align-items: flex-start;
        }

        /* Minimizer toggle button */
        .speed-controls-toggle {
            background: rgba(255, 204, 0, 0.95);
            color: #1a1a1a;
            border: 2px solid #e6b800;
            width: 68px;
            height: 68px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.4rem;
            font-weight: 700;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(255, 204, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            align-self: flex-start;
        }

        .speed-controls-toggle:hover {
            background: rgba(255, 204, 0, 1);
            border-color: #e6b800;
            transform: scale(1.1);
        }

        /* Collapsible buttons wrapper */
        .speed-controls-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.35s ease;
            overflow: hidden;
            max-height: 600px;
            opacity: 1;
        }

        .speed-controls-buttons.collapsed {
            max-height: 0;
            opacity: 0;
            pointer-events: none;
        }

        .speed-btn, .pause-btn {
            background: rgba(0, 122, 255, 0.95);
            color: white;
            border: 2px solid #007aff;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            width: 60px;
            height: 60px;
            min-height: unset;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.3);
            flex-shrink: 0;
        }

        .speed-btn:hover, .pause-btn:hover {
            background: rgba(0, 122, 255, 1);
            border-color: #007aff;
            transform: translateY(-2px);
            color: white;
        }

        .speed-btn.active {
            background: rgba(0, 90, 200, 0.95);
            border-color: #007aff;
            color: white;
        }

        /* Frame Control Buttons */
        .frame-btn {
            background: rgba(0, 122, 255, 0.95);
            color: white;
            border: 2px solid #007aff;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            width: 60px;
            height: 60px;
            min-height: unset;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.3);
            flex-shrink: 0;
        }

        .frame-btn:hover {
            background: rgba(0, 122, 255, 1);
            border-color: #007aff;
            transform: translateY(-2px);
            color: white;
        }

        .frame-btn:active {
            transform: translateY(0);
        }

        .pause-btn {
            background: rgba(0, 122, 255, 0.95);
            border-color: #007aff;
            font-size: 1.3rem;
            color: white;
        }

        .pause-btn:hover {
            background: rgba(0, 122, 255, 1);
            color: white;
        }

        .pause-btn.paused {
            background: rgba(0, 122, 255, 0.95);
            border-color: #007aff;
            color: white;
        }

        .replay-btn {
            background: rgba(0, 122, 255, 0.95);
            border-color: #007aff;
            font-size: 1.3rem;
            color: white;
            font-weight: 700;
        }

        .replay-btn:hover {
            background: rgba(0, 122, 255, 1);
            color: white;
        }

        .replay-btn.active {
            background: rgba(0, 90, 200, 0.95);
            border-color: #007aff;
            color: white;
        }

        .fullscreen-btn {
            background: rgba(0, 122, 255, 0.95);
            border: 2px solid #007aff;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            color: white;
            font-weight: 700;
            width: 60px;
            height: 60px;
            min-height: unset;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.3);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .fullscreen-btn:hover {
            background: rgba(0, 122, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 122, 255, 0.6);
            color: white;
        }

        .fullscreen-btn:active {
            transform: translateY(0);
        }

        .record-btn {
            background: rgba(255, 45, 85, 0.95);
            border: 2px solid #ff2d55;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            color: white;
            font-weight: 700;
            width: 60px;
            height: 60px;
            min-height: unset;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(255, 45, 85, 0.4);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .record-btn:hover {
            background: rgba(255, 45, 85, 1);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 45, 85, 0.6);
            color: white;
        }

        .record-btn:active {
            transform: translateY(0);
        }

        /* Mini Fullscreen Window */
        .mini-fullscreen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            max-width: 800px;
            height: 80vh;
            background: #000;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            overflow: hidden;
        }

        .mini-fullscreen.active {
            display: block;
            animation: fadeInScale 0.3s ease;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .mini-fullscreen-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 59, 48, 0.95);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            z-index: 2001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .mini-fullscreen-close:hover {
            background: rgba(255, 59, 48, 1);
            transform: scale(1.1);
        }

        .mini-fullscreen video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Controls inside mini fullscreen */
        .mini-fullscreen-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 2002;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90%;
        }

        .mini-control-btn {
            background: rgba(0, 122, 255, 0.95);
            color: white;
            border: 2px solid #007aff;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.3);
        }

        .mini-control-btn:hover {
            background: rgba(0, 122, 255, 1);
            border-color: #007aff;
            transform: translateY(-2px);
        }

        .mini-control-btn.active {
            background: rgba(0, 90, 200, 0.95);
            border-color: #007aff;
        }

        .mini-pause-btn {
            background: rgba(0, 122, 255, 0.95);
            border-color: #007aff;
            font-size: 1.2rem;
        }

        .mini-pause-btn:hover {
            background: rgba(0, 122, 255, 1);
        }

        .mini-pause-btn.paused {
            background: rgba(0, 122, 255, 0.95);
            border-color: #007aff;
        }

        .mini-replay-btn {
            background: rgba(0, 122, 255, 0.95);
            border-color: #007aff;
            font-size: 1.2rem;
            color: white;
            font-weight: 700;
        }

        .mini-replay-btn:hover {
            background: rgba(0, 122, 255, 1);
            color: white;
        }

        .mini-replay-btn.active {
            background: rgba(0, 90, 200, 0.95);
            border-color: #007aff;
            color: white;
        }

        .mini-next-btn {
            background: rgba(0, 122, 255, 0.95);
            border-color: #007aff;
            font-size: 1.2rem;
        }

        .mini-next-btn:hover {
            background: rgba(0, 122, 255, 1);
        }

        .mini-record-btn {
            background: rgba(255, 45, 85, 0.95) !important;
            border-color: #ff2d55 !important;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(255, 45, 85, 0.4) !important;
        }

        .mini-record-btn:hover {
            background: rgba(255, 45, 85, 1) !important;
            border-color: #ff2d55 !important;
            box-shadow: 0 8px 30px rgba(255, 45, 85, 0.6) !important;
        }

        .mini-fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: none;
            backdrop-filter: blur(5px);
        }

        .mini-fullscreen-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Camera Recording Mode */
        .video-camera-wrapper {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 50%;
            max-width: 600px;
            flex-shrink: 0;
        }
        
        .video-controls-camera-mode {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .camera-mode-active .gallery {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        .camera-mode-active .gallery .video-item {
            width: 100%;
            max-width: none;
        }
        
        .camera-mode-active .gallery .video-wrapper {
            max-height: 800px;
        }

        .camera-mode-active .video-item:not(.has-sound) {
            display: none;
        }

        /* Container para v√≠deo e c√¢mera lado a lado */
        body.camera-mode-active {
            display: flex;
            flex-direction: column;
        }

        .side-by-side-container {
            display: none;
            gap: 40px;
            max-width: 1600px;
            margin: 30px auto;
            padding: 0 20px;
            width: 100%;
            justify-content: center;
            align-items: flex-start;
        }

        body.camera-mode-active .side-by-side-container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
        }

        body.camera-mode-active > .gallery {
            display: none;
        }
        
        body.camera-mode-active #galleryNormal {
            display: none !important;
        }

        .camera-container {
            display: none;
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #ff2d55;
            box-shadow: 0 10px 30px rgba(255, 45, 85, 0.3);
            width: 50%;
            max-width: 600px;
            flex-shrink: 0;
        }

        .camera-container.active {
            display: block;
        }

        .camera-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ff2d55;
            margin-bottom: 15px;
            text-align: center;
        }

        .camera-wrapper {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            aspect-ratio: 9/16;
            max-height: 800px;
        }

        .camera-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background: #000;
            object-fit: cover;
        }

        .camera-video.active {
            display: block !important;
        }

        .camera-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.2rem;
            flex-direction: column;
            gap: 15px;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .camera-btn {
            background: rgba(255, 255, 255, 0.95);
            color: #1a1a1a;
            border: 2px solid #ddd;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .camera-btn:hover {
            background: rgba(102, 126, 234, 0.95);
            border-color: #667eea;
            transform: translateY(-2px);
            color: white;
        }

        .camera-btn.primary {
            background: rgba(255, 45, 85, 0.95);
            border-color: #ff2d55;
            color: white;
        }

        .camera-btn.primary:hover {
            background: rgba(255, 45, 85, 1);
        }

        .camera-btn.recording {
            animation: pulse 1.5s infinite;
        }

        .camera-btn.success {
            background: rgba(52, 199, 89, 0.95);
            border-color: #34c759;
            color: white;
        }

        .camera-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .recording-indicator-camera {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            color: #ff2d55;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .recording-indicator-camera.active {
            display: flex;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #ff2d55;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        .recording-timer {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: #ff2d55;
            margin: 10px 0;
            display: none;
        }

        .recording-timer.active {
            display: block;
        }

        .close-camera-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 59, 48, 0.95);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-camera-btn:hover {
            background: rgba(255, 59, 48, 1);
            transform: scale(1.1);
        }

        /* Media queries para telas menores - ajustar apenas tamanhos, n√£o dire√ß√£o */
        @media (max-width: 968px) {
            body.camera-mode-active .side-by-side-container {
                gap: 20px;
                padding: 0 10px;
            }

            .video-camera-wrapper,
            .camera-container {
                width: 48%;
            }
            
            .camera-mode-active .gallery .video-wrapper {
                max-height: 600px;
            }
            
            .camera-wrapper {
                max-height: 600px !important;
            }
        }
        
        @media (max-width: 600px) {
            body.camera-mode-active .side-by-side-container {
                gap: 10px;
                padding: 0 5px;
            }

            .video-camera-wrapper,
            .camera-container {
                width: 48%;
            }
            
            .camera-title {
                font-size: 1rem;
            }
            
            .camera-btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }

        /* Next Video Button */
        .next-video-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .next-video-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }

        .next-video-btn:active {
            transform: scale(0.95);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.2rem;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .speed-controls {
                bottom: 20px;
                left: 20px;
            }

            .next-video-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .speed-btn, .pause-btn {
                font-size: 0.85rem;
                width: 52px;
                height: 52px;
            }
        }

        .stats {
            text-align: center;
            color: #999;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .delete-all-btn {
            background: linear-gradient(135deg, #ff3b30 0%, #ff6b6b 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            margin-top: 15px;
            display: inline-block;
        }

        .delete-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 59, 48, 0.4);
        }

        .delete-all-btn:active {
            transform: translateY(0);
        }

        /* Recording Preview Styles */
        .recording-preview-container {
            max-width: 600px;
            margin: 30px auto;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 2px solid #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
        }

        .preview-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #667eea;
            text-align: center;
            margin-bottom: 15px;
        }

        .preview-video-wrapper {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 15px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 9 / 16;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .preview-video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
            background: #000;
        }

        .download-preview-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .download-preview-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .download-preview-btn:active {
            transform: translateY(0);
        }

        .video-name-editor {
            margin-bottom: 15px;
        }

        .video-name-editor label {
            display: block;
            font-size: 0.95rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .video-name-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .video-name-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .video-name-input::placeholder {
            color: #aaa;
        }

        .copy-name-btn {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .copy-name-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .copy-name-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé¨ Galeria de V√≠deos</h1>
    </div>

    <div class="upload-section">
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
            üì§ Importar V√≠deos
        </button>
        <input type="file" id="fileInput" accept="video/*,video/mp4,video/webm,video/ogg,video/quicktime" multiple>
        <div class="stats" id="stats">Nenhum v√≠deo importado</div>
        <div style="color: #999; font-size: 0.85rem; margin-top: 10px;">
            üí° Dica: Para importar muitos v√≠deos, use a aba "V√≠deos" ao inv√©s de "Cole√ß√µes"
        </div>
        <button class="delete-all-btn" onclick="deleteAllVideos()" id="deleteAllBtn" style="display: none;">
            üóëÔ∏è Excluir Todos os V√≠deos
        </button>
    </div>

    <!-- Galeria Normal (quando n√£o est√° em modo c√¢mera) -->
    <div class="gallery" id="galleryNormal"></div>

    <!-- Container para V√≠deo e C√¢mera Lado a Lado -->
    <div class="side-by-side-container">
        <div class="video-camera-wrapper">
            <div class="gallery" id="gallery"></div>
            <div class="video-controls-camera-mode">
                <button class="camera-btn" onclick="toggleVideoPlayPause()" id="videoPlayPauseBtn">‚è∏ Pausar V√≠deo</button>
            </div>
        </div>
        
        <!-- Camera Container -->
        <div class="camera-container" id="cameraContainer">
            <button class="close-camera-btn" onclick="closeCamera()">√ó</button>
            <div class="camera-title">üì∑ Sua C√¢mera</div>
            <div class="camera-wrapper">
                <div class="camera-placeholder" id="cameraPlaceholder">
                    <span>üì∑</span>
                    <span>Clique em "Iniciar C√¢mera" para ver o preview</span>
                </div>
                <video class="camera-video" id="cameraVideo" autoplay playsinline muted></video>
            </div>
            
            <div class="recording-indicator-camera" id="recordingIndicatorCamera">
                <div class="recording-dot"></div>
                <span>GRAVANDO</span>
            </div>
            
            <div class="recording-timer" id="recordingTimer">00:00</div>
            
            <div class="camera-controls">
                <button class="camera-btn primary" onclick="startCameraRecording()" id="startCameraBtn">üì∑ Iniciar C√¢mera</button>
                <button class="camera-btn" onclick="toggleRecording()" id="recordCameraBtn" disabled>‚è∫ Gravar</button>
                <button class="camera-btn" onclick="toggleCameraPause()" id="pauseCameraBtn" disabled>‚è∏ Pausar</button>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading" style="display: none;">Carregando v√≠deos...</div>

    <!-- Preview da Grava√ß√£o (movido para c√° para ficar sempre vis√≠vel) -->
    <div class="recording-preview-container" id="recordingPreviewContainer" style="display: none;">
        <div class="preview-title">üé¨ Preview da Grava√ß√£o</div>
        <div class="preview-video-wrapper">
            <video class="preview-video" id="previewVideo" controls playsinline></video>
        </div>
        <div class="video-name-editor">
            <label for="videoNameInput">üìù Nome do arquivo:</label>
            <div style="display: flex; gap: 10px; align-items: stretch;">
                <input type="text" id="videoNameInput" class="video-name-input" placeholder="Digite o nome do v√≠deo" style="flex: 1;">
                <button onclick="copyFileName()" class="copy-name-btn" title="Copiar nome">üìã</button>
            </div>
            <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                üí° Se o nome n√£o funcionar automaticamente, use o bot√£o üìã para copiar e renomear manualmente
            </div>
        </div>
        <button class="download-preview-btn" onclick="downloadPreview()" id="downloadPreviewBtn">
            üì• Baixar V√≠deo
        </button>
    </div>

    <!-- Speed Controls -->
    <div class="speed-controls" id="speedControls">
        <div class="speed-controls-buttons collapsed" id="speedControlsButtons">
            <button class="speed-btn" onclick="setSpeed(0.5)" id="speed-0.5">0.5x</button>
            <button class="speed-btn active" onclick="setSpeed(1.0)" id="speed-1">1.0x</button>
            <button class="speed-btn" onclick="setSpeed(1.5)" id="speed-1.5">1.5x</button>
            <button class="pause-btn" onclick="togglePause()" id="pauseBtn">‚è∏</button>
            <button class="replay-btn" onclick="slowReplay()" id="replayBtn">‚è™</button>
            <button class="frame-btn" onclick="frameBackward()" id="frameBackBtn" title="Retroceder 15 frames">‚èÆÔ∏è</button>
            <button class="frame-btn" onclick="frameForward()" id="frameForwardBtn" title="Avan√ßar 15 frames">‚è≠Ô∏è</button>
        </div>
        <button class="record-btn" onclick="sendToRecorder()" id="recordBtn">üìπ</button>
        <button class="fullscreen-btn" onclick="openMiniFullscreen()" id="fullscreenBtn">‚õ∂</button>
        <button class="speed-controls-toggle" onclick="toggleSpeedControls()" id="speedControlsToggle" title="Expandir controles">+</button>
    </div>

    <!-- Next Video Button -->
    <button class="next-video-btn" onclick="goToNextVideo()" title="Pr√≥ximo v√≠deo">‚è≠Ô∏è</button>

    <!-- Mini Fullscreen Window -->
    <div class="mini-fullscreen-overlay" id="miniFullscreenOverlay" onclick="closeMiniFullscreen()"></div>
    <div class="mini-fullscreen" id="miniFullscreen">
        <button class="mini-fullscreen-close" onclick="closeMiniFullscreen()">√ó</button>
        <video id="miniFullscreenVideo" loop playsinline></video>
        
        <!-- Controls inside mini fullscreen -->
        <div class="mini-fullscreen-controls">
            <button class="mini-control-btn" onclick="setMiniSpeed(0.5)" id="mini-speed-0.5">0.5x</button>
            <button class="mini-control-btn active" onclick="setMiniSpeed(1.0)" id="mini-speed-1">1.0x</button>
            <button class="mini-control-btn" onclick="setMiniSpeed(1.5)" id="mini-speed-1.5">1.5x</button>
            <button class="mini-pause-btn mini-control-btn" onclick="toggleMiniPause()" id="miniPauseBtn">‚è∏</button>
            <button class="mini-replay-btn mini-control-btn" onclick="miniSlowReplay()" id="miniReplayBtn">‚è™</button>
            <button class="mini-next-btn mini-control-btn" onclick="miniGoToNext()" id="miniNextBtn">‚è≠Ô∏è</button>
            <button class="mini-record-btn mini-control-btn" onclick="closeMiniFullscreen(); sendToRecorder();">üìπ</button>
        </div>
    </div>

    <script>
        // Global Variables
        let videos = [];
        let currentSpeed = parseFloat(localStorage.getItem('videoSpeed')) || 1.0;
        let isScrolling = false;
        let scrollTimeout;
        let db;
        let videoUrls = {};
        let isPaused = false;
        let slowReplayTimeout = null;
        let previousSpeed = 1.0;
        let miniFullscreenActive = false;
        let currentFullscreenVideo = null;
        let miniSlowReplayTimeout = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            db = await initDB();
            await loadVideos();
            initSpeedButtons();
            
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // Scroll detection
            window.addEventListener('scroll', function() {
                isScrolling = true;
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => isScrolling = false, 150);
            }, false);
        });

        // Toggle floating controls minimizer
        function toggleSpeedControls() {
            const buttons = document.getElementById('speedControlsButtons');
            const toggle = document.getElementById('speedControlsToggle');
            const isCollapsed = buttons.classList.toggle('collapsed');
            toggle.textContent = isCollapsed ? '+' : '‚àí';
            toggle.title = isCollapsed ? 'Expandir controles' : 'Minimizar controles';
        }

        // Collapse all floating buttons (except fullscreen) ‚Äî called by üìπ
        function collapseSpeedControls() {
            const buttons = document.getElementById('speedControlsButtons');
            const toggle = document.getElementById('speedControlsToggle');
            if (!buttons.classList.contains('collapsed')) {
                buttons.classList.add('collapsed');
                toggle.textContent = '+';
                toggle.title = 'Expandir controles';
            }
        }

        // IndexedDB Functions
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('VideoGalleryDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('videos')) {
                        db.createObjectStore('videos', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        function saveVideoToDB(videoData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['videos'], 'readwrite');
                const store = transaction.objectStore('videos');
                const request = store.add(videoData);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Function to check if a string starts with an emoji
        function startsWithEmoji(str) {
            if (!str) return false;
            
            // Regex que detecta emojis no in√≠cio da string
            const emojiRegex = /^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F000}-\u{1F02F}\u{1F0A0}-\u{1F0FF}\u{1F100}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2300}-\u{23FF}\u{2B50}\u{2B55}\u{231A}\u{231B}\u{2328}\u{23CF}\u{23E9}-\u{23F3}\u{23F8}-\u{23FA}\u{24C2}\u{25AA}\u{25AB}\u{25B6}\u{25C0}\u{25FB}-\u{25FE}\u{2600}-\u{2604}\u{260E}\u{2611}\u{2614}\u{2615}\u{2618}\u{261D}\u{2620}\u{2622}\u{2623}\u{2626}\u{262A}\u{262E}\u{262F}\u{2638}-\u{263A}\u{2640}\u{2642}\u{2648}-\u{2653}\u{265F}\u{2660}\u{2663}\u{2665}\u{2666}\u{2668}\u{267B}\u{267E}\u{267F}\u{2692}-\u{2697}\u{2699}\u{269B}\u{269C}\u{26A0}\u{26A1}\u{26A7}\u{26AA}\u{26AB}\u{26B0}\u{26B1}\u{26BD}\u{26BE}\u{26C4}\u{26C5}\u{26C8}\u{26CE}\u{26CF}\u{26D1}\u{26D3}\u{26D4}\u{26E9}\u{26EA}\u{26F0}-\u{26F5}\u{26F7}-\u{26FA}\u{26FD}\u{2702}\u{2705}\u{2708}-\u{270D}\u{270F}\u{2712}\u{2714}\u{2716}\u{271D}\u{2721}\u{2728}\u{2733}\u{2734}\u{2744}\u{2747}\u{274C}\u{274E}\u{2753}-\u{2755}\u{2757}\u{2763}\u{2764}\u{2795}-\u{2797}\u{27A1}\u{27B0}\u{27BF}\u{2934}\u{2935}\u{2B05}-\u{2B07}\u{2B1B}\u{2B1C}\u{2B50}\u{2B55}\u{3030}\u{303D}\u{3297}\u{3299}]/u;
            
            return emojiRegex.test(str);
        }

        function loadVideosFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['videos'], 'readonly');
                const store = transaction.objectStore('videos');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    // Mostrar apenas v√≠deos que COME√áAM com emoji
                    const allVideos = request.result;
                    const filteredVideos = allVideos.filter(video => startsWithEmoji(video.name));
                    resolve(filteredVideos);
                };
                request.onerror = () => reject(request.error);
            });
        }

        function deleteVideoFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['videos'], 'readwrite');
                const store = transaction.objectStore('videos');
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // File Upload
        async function handleFileUpload(e) {
            const files = Array.from(e.target.files);
            
            if (files.length === 0) return;
            
            console.log(`Iniciando upload de ${files.length} arquivos...`);
            
            document.getElementById('loading').style.display = 'block';
            const stats = document.getElementById('stats');
            
            let successCount = 0;
            let errorCount = 0;
            
            // Process files in batches to avoid memory issues
            const batchSize = 5;
            for (let i = 0; i < files.length; i += batchSize) {
                const batch = files.slice(i, i + batchSize);
                
                // Update progress
                stats.textContent = `Processando ${i + 1}-${Math.min(i + batchSize, files.length)} de ${files.length} v√≠deos...`;
                
                await Promise.all(batch.map(async (file) => {
                    try {
                        console.log(`Processando: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
                        
                        // Convert file to arrayBuffer for better storage
                        const arrayBuffer = await file.arrayBuffer();
                        const blob = new Blob([arrayBuffer], { type: file.type });
                        
                        const videoData = {
                            name: file.name,
                            blob: blob,
                            type: file.type,
                            timestamp: Date.now()
                        };
                        
                        const id = await saveVideoToDB(videoData);
                        videos.push({ id, name: file.name, blob: blob, type: file.type });
                        successCount++;
                        console.log(`‚úì Salvo: ${file.name}`);
                    } catch (error) {
                        console.error(`‚úó Erro ao processar: ${file.name}`, error);
                        errorCount++;
                    }
                }));
                
                // Small delay between batches to avoid blocking
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.log(`Upload conclu√≠do: ${successCount} sucessos, ${errorCount} erros`);
            
            videos = sortVideos(videos);
            renderGallery();
            updateStats();
            
            document.getElementById('loading').style.display = 'none';
            
            // Show result message
            if (errorCount > 0) {
                alert(`${successCount} v√≠deos importados com sucesso.\n${errorCount} v√≠deos falharam.`);
            } else if (successCount > 0) {
                alert(`${successCount} v√≠deos importados com sucesso!`);
            }
            
            e.target.value = '';
        }

        // Load Videos
        async function loadVideos() {
            document.getElementById('loading').style.display = 'block';
            const loadedVideos = await loadVideosFromDB();
            
            // Process videos to ensure blobs are properly formatted
            videos = loadedVideos.map(video => {
                // Ensure blob has correct type
                if (video.blob && video.type) {
                    return {
                        ...video,
                        blob: new Blob([video.blob], { type: video.type })
                    };
                }
                return video;
            });
            
            videos = sortVideos(videos);
            renderGallery();
            updateStats();
            document.getElementById('loading').style.display = 'none';
        }

        // Sort Videos
        function sortVideos(videosArray) {
            // Helper: remove extens√£o do nome (ex: "6666661.mp4" ‚Üí "6666661")
            function stripExt(name) {
                return name.replace(/\.[^.]+$/, '');
            }

            // Helper: separa base e √∫ltimo d√≠gito do nome sem extens√£o
            // Usa APENAS o √∫ltimo caractere como sufixo num√©rico
            // Ex: "0066666660" ‚Üí { base: "006666666", num: 0 }  ‚Üê zero final = final 0
            // Ex: "6666661"    ‚Üí { base: "666666",    num: 1 }
            // Ex: "6666662"    ‚Üí { base: "666666",    num: 2 }  ‚Üê par com o de cima
            // Ex: "myvideo"    ‚Üí { base: "myvideo",   num: null }
            function parseNameParts(name) {
                const noExt = stripExt(name);
                const lastChar = noExt.slice(-1);
                if (/\d/.test(lastChar)) {
                    return { base: noExt.slice(0, -1), num: parseInt(lastChar) };
                }
                return { base: noExt, num: null };
            }

            // Agrupa por emoji (chave do grupo)
            const grouped = {};
            videosArray.forEach(video => {
                const emoji = extractEmojis(video.name);
                const key = emoji || '_no_emoji_';
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(video);
            });

            // Dentro de cada grupo: separa finais 0, forma pares nos demais
            Object.keys(grouped).forEach(key => {
                const vids = grouped[key];

                // Separa v√≠deos com n√∫mero final === 0 dos demais
                const zeros = [];
                const rest  = [];
                vids.forEach(v => {
                    const p = parseNameParts(v.name);
                    if (p.num !== null && p.num === 0) {
                        zeros.push(v);
                    } else {
                        rest.push(v);
                    }
                });

                // Forma pares consecutivos (diferen√ßa de 1) nos v√≠deos restantes
                const pairs = [];
                const used  = new Set();

                for (let i = 0; i < rest.length; i++) {
                    if (used.has(i)) continue;

                    const p1 = parseNameParts(rest[i].name);

                    if (p1.num !== null) {
                        let foundPair = false;
                        for (let j = i + 1; j < rest.length; j++) {
                            if (used.has(j)) continue;

                            const p2 = parseNameParts(rest[j].name);

                            if (
                                p2.num !== null &&
                                p1.base === p2.base &&
                                Math.abs(p1.num - p2.num) === 1
                            ) {
                                // Garante n√∫mero menor (1) antes do maior (2)
                                const first  = p1.num < p2.num ? rest[i] : rest[j];
                                const second = p1.num < p2.num ? rest[j] : rest[i];
                                pairs.push([first, second]);
                                used.add(i);
                                used.add(j);
                                foundPair = true;
                                break;
                            }
                        }
                        if (!foundPair) {
                            pairs.push([rest[i]]);
                            used.add(i);
                        }
                    } else {
                        pairs.push([rest[i]]);
                        used.add(i);
                    }
                }

                // Zeros embaralhados no in√≠cio, depois pares/singletons embaralhados
                grouped[key] = [
                    ...shuffleArray(zeros),
                    ...shuffleArray(pairs).flat()
                ];
            });

            // Monta resultado: cada grupo de emoji √© um bloco
            // A ordem dos blocos √© aleat√≥ria, mas dentro de cada bloco zeros v√™m primeiro
            const emojiKeys = Object.keys(grouped).filter(k => k !== '_no_emoji_');
            const withoutEmoji = grouped['_no_emoji_'] || [];

            const shuffledEmojiKeys = shuffleArray(emojiKeys);

            const result = [];
            shuffledEmojiKeys.forEach(key => {
                result.push(...grouped[key]);
            });
            result.push(...withoutEmoji);

            return result;
        }

        // Extract Emojis
        function extractEmojis(text) {
            const emojiRegex = /[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F000}-\u{1F02F}\u{1F0A0}-\u{1F0FF}\u{1F100}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{FE00}-\u{FE0F}\u{200D}]/gu;
            const emojis = text.match(emojiRegex);
            return emojis ? emojis.join('') : '';
        }

        // Shuffle Array (Fisher-Yates)
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Get Video URL
        function getVideoUrl(video) {
            if (!video || !video.blob) {
                console.error('Invalid video object:', video);
                return '';
            }
            
            if (!videoUrls[video.id]) {
                try {
                    // Create blob URL with proper type
                    const blob = video.type ? 
                        new Blob([video.blob], { type: video.type }) : 
                        video.blob;
                    videoUrls[video.id] = URL.createObjectURL(blob);
                } catch (error) {
                    console.error('Error creating URL for video:', video.name, error);
                    return '';
                }
            }
            return videoUrls[video.id];
        }

        // Render Gallery
        // Intersection Observers (definir antes das fun√ß√µes que os usam)
        const playObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const item = entry.target;
                const videoEl = item.querySelector('video');
                if (!videoEl) return;
                
                const videoId = parseInt(videoEl.dataset.videoId);
                const video = videos.find(v => v.id === videoId);

                // Don't pause if in camera mode and this is the video with sound
                const isCameraMode = document.body.classList.contains('camera-mode-active');
                const hasSound = item.classList.contains('has-sound');
                
                if (entry.isIntersecting) {
                    if (!videoEl.src && video) {
                        const url = getVideoUrl(video);
                        if (url) {
                            videoEl.src = url;
                        }
                    }
                    videoEl.playbackRate = currentSpeed;
                    if (!isPaused) {
                        videoEl.play().catch(err => {
                            console.log('Play error (normal on some browsers):', err.message);
                        });
                    }
                    item.classList.add('playing');
                } else {
                    // Only pause if NOT in camera mode OR if it doesn't have sound
                    if (!isCameraMode || !hasSound) {
                        videoEl.pause();
                        videoEl.currentTime = 0;
                        item.classList.remove('playing');
                        if (!hasSound) {
                            videoEl.muted = true;
                            item.classList.remove('has-sound');
                        }
                    }
                }
            });
        }, { threshold: 0.5 });

        const preloadObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const videoEl = entry.target.querySelector('video');
                if (!videoEl) return;
                
                const videoId = parseInt(videoEl.dataset.videoId);
                const video = videos.find(v => v.id === videoId);

                if (entry.isIntersecting && !videoEl.src && video) {
                    const url = getVideoUrl(video);
                    if (url) {
                        videoEl.src = url;
                        videoEl.load();
                    }
                }
            });
        }, { rootMargin: '400px' });

        function renderGallery() {
            const gallery = document.getElementById('gallery');
            const galleryNormal = document.getElementById('galleryNormal');
            gallery.innerHTML = '';
            galleryNormal.innerHTML = '';

            videos.forEach((video, index) => {
                // Criar item para galeria normal
                const itemNormal = createVideoItem(video, index);
                galleryNormal.appendChild(itemNormal);
                
                // Criar item para galeria do modo c√¢mera
                const itemCamera = createVideoItem(video, index);
                gallery.appendChild(itemCamera);
            });
        }
        
        function createVideoItem(video, index) {
                const item = document.createElement('div');
                item.className = 'video-item';
                item.dataset.index = index;
                item.dataset.id = video.id;

                item.innerHTML = `
                    <button class="delete-btn" onclick="deleteVideo(${video.id})">√ó</button>
                    <div class="video-wrapper">
                        <video data-video-id="${video.id}" preload="none" muted loop playsinline></video>
                        <div class="sound-icon">üîä</div>
                        <div class="video-overlay">
                            <div class="play-icon"></div>
                        </div>
                    </div>
                    <div class="video-info">
                        <div class="video-name">${video.name}</div>
                    </div>
                `;

                const videoEl = item.querySelector('video');
                
                // Add error handling
                videoEl.addEventListener('error', (e) => {
                    console.error('Video error for:', video.name, e);
                    // Try to reload
                    if (videoEl.src && !videoEl.dataset.retried) {
                        videoEl.dataset.retried = 'true';
                        const url = getVideoUrl(video);
                        videoEl.src = url;
                        videoEl.load();
                    }
                });
                
                // Click to toggle sound and play/pause
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-btn') || 
                        e.target.closest('.delete-btn') || 
                        isScrolling) return;
                    
                    e.preventDefault();
                    
                    // Verifica se √© o primeiro clique neste v√≠deo
                    const isFirstClick = !videoEl.dataset.hasBeenClicked;
                    
                    if (isFirstClick) {
                        // PRIMEIRO CLIQUE: Reinicia, liga o som e toca
                        // Mute all others e RESETA o estado de clicado deles
                        document.querySelectorAll('.video-item video').forEach(v => {
                            if (v !== videoEl) {
                                v.muted = true;
                                v.closest('.video-item').classList.remove('has-sound');
                                // IMPORTANTE: Remove o flag de "j√° clicado" dos outros v√≠deos
                                delete v.dataset.hasBeenClicked;
                            }
                        });
                        
                        // Reinicia este v√≠deo
                        videoEl.currentTime = 0;
                        videoEl.muted = false;
                        videoEl.play();
                        item.classList.add('has-sound');
                        
                        // Marca que j√° foi clicado
                        videoEl.dataset.hasBeenClicked = 'true';
                    } else {
                        // CLIQUES SEGUINTES: Alterna pause/play (mant√©m o som sempre ligado)
                        if (videoEl.paused) {
                            videoEl.muted = false; // Garante que o som est√° ligado
                            videoEl.play();
                        } else {
                            videoEl.pause();
                        }
                    }
                });

                // Touch/mousedown tracking (n√£o usado mais, mas mantido para compatibilidade)
                let touchStartTime = 0;
                videoEl.addEventListener('mousedown', (e) => {
                    touchStartTime = Date.now();
                });
                
                videoEl.addEventListener('touchstart', (e) => {
                    touchStartTime = Date.now();
                });

                // Removidos os eventos que reiniciavam o v√≠deo

                // Click no nome do v√≠deo para reiniciar
                const videoName = item.querySelector('.video-name');
                videoName.addEventListener('click', (e) => {
                    e.stopPropagation(); // Impede que o clique no nome acione o clique do item
                    videoEl.currentTime = 0; // Reinicia o v√≠deo
                    videoEl.pause(); // Pausa primeiro
                    
                    // Espera 1,5 segundos e depois d√° play
                    setTimeout(() => {
                        videoEl.play();
                    }, 1500);
                });

                // Attach observers
                playObserver.observe(item);
                preloadObserver.observe(item);
                
                return item;
        }

        // Delete Video
        async function deleteVideo(id) {
            if (!confirm('Deletar este v√≠deo permanentemente?')) return;
            
            await deleteVideoFromDB(id);
            
            if (videoUrls[id]) {
                URL.revokeObjectURL(videoUrls[id]);
                delete videoUrls[id];
            }
            
            videos = videos.filter(v => v.id !== id);
            renderGallery();
            updateStats();
        }

        // Delete All Videos
        async function deleteAllVideos() {
            if (!confirm(`Tem certeza que deseja excluir TODOS os ${videos.length} v√≠deos?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) return;
            
            document.getElementById('loading').style.display = 'block';
            
            // Clear all video URLs
            Object.keys(videoUrls).forEach(id => {
                URL.revokeObjectURL(videoUrls[id]);
            });
            videoUrls = {};
            
            // Delete all from IndexedDB
            try {
                const transaction = db.transaction(['videos'], 'readwrite');
                const store = transaction.objectStore('videos');
                await store.clear();
                
                // Wait for transaction to complete
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = resolve;
                    transaction.onerror = reject;
                });
                
                videos = [];
                renderGallery();
                updateStats();
                
                document.getElementById('loading').style.display = 'none';
                alert('Todos os v√≠deos foram exclu√≠dos com sucesso!');
            } catch (error) {
                console.error('Error deleting all videos:', error);
                document.getElementById('loading').style.display = 'none';
                alert('Erro ao excluir v√≠deos. Tente novamente.');
            }
        }

        // Speed Control
        function setSpeed(speed) {
            currentSpeed = speed;
            localStorage.setItem('videoSpeed', speed);
            
            document.querySelectorAll('.video-item video').forEach(video => {
                video.playbackRate = speed;
            });
            
            // Update button states
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`speed-${speed}`).classList.add('active');
        }

        function initSpeedButtons() {
            setSpeed(currentSpeed);
        }

        // Pause Control
        function togglePause() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            // Find video with sound
            const videoWithSound = document.querySelector('.video-item.has-sound video');
            
            if (videoWithSound) {
                if (isPaused) {
                    videoWithSound.pause();
                    pauseBtn.textContent = '‚ñ∂';
                    pauseBtn.classList.add('paused');
                } else {
                    videoWithSound.play().catch(() => {});
                    pauseBtn.textContent = '‚è∏';
                    pauseBtn.classList.remove('paused');
                }
            }
        }

        // Next Video
        function goToNextVideo() {
            const videoItems = Array.from(document.querySelectorAll('.video-item'));
            let currentSoundIndex = -1;
            
            videoItems.forEach((item, index) => {
                if (item.classList.contains('has-sound')) {
                    currentSoundIndex = index;
                }
            });
            
            if (currentSoundIndex === -1) return;
            
            const nextIndex = (currentSoundIndex + 1) % videos.length;
            const nextVideoItem = videoItems[nextIndex];
            
            if (nextVideoItem) {
                // Mute all
                document.querySelectorAll('.video-item video').forEach(v => {
                    v.muted = true;
                    v.closest('.video-item').classList.remove('has-sound');
                });

                // Scroll to next
                nextVideoItem.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Unmute next video
                setTimeout(() => {
                    const video = nextVideoItem.querySelector('video');
                    video.muted = false;
                    video.currentTime = 0;
                    nextVideoItem.classList.add('has-sound');
                    
                    // Reset pause state
                    isPaused = false;
                    document.getElementById('pauseBtn').textContent = '‚è∏';
                    document.getElementById('pauseBtn').classList.remove('paused');
                }, 500);
            }
        }

        // Update Stats
        function updateStats() {
            const stats = document.getElementById('stats');
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            
            if (videos.length === 0) {
                stats.textContent = 'Nenhum v√≠deo importado';
                deleteAllBtn.style.display = 'none';
            } else {
                stats.textContent = `${videos.length} v√≠deo${videos.length > 1 ? 's' : ''} na galeria`;
                deleteAllBtn.style.display = 'inline-block';
            }
        }

        // Frame Control Functions
        // Assumindo 30fps padr√£o: 15 frames = 0.5 segundos
        let frameForwardTimeout = null;
        let frameBackwardTimeout = null;
        
        function frameForward() {
            const videoWithSound = document.querySelector('.video-item.has-sound video');
            if (!videoWithSound) return;
            
            // Limpar timeout anterior se existir
            if (frameForwardTimeout) {
                clearTimeout(frameForwardTimeout);
            }
            
            // Tocar em c√¢mera lenta 0.4x
            videoWithSound.playbackRate = 0.4;
            
            // Dar play
            videoWithSound.play();
            
            // Calcular quanto tempo leva para tocar 15 frames em 0.4x
            // 15 frames em 30fps = 0.5 segundos de v√≠deo
            // Em 0.4x, leva 0.5 / 0.4 = 1.25 segundos reais
            const frameTime = 15 / 30; // 0.5 segundos de v√≠deo
            const realTime = frameTime / 0.4; // tempo real para tocar em 0.4x
            
            // Feedback visual no bot√£o
            const frameBtn = document.getElementById('frameForwardBtn');
            frameBtn.style.background = 'rgba(255, 152, 0, 0.95)';
            frameBtn.style.borderColor = '#ff9800';
            frameBtn.style.color = 'white';
            
            // Depois de tocar os 15 frames, pausar
            frameForwardTimeout = setTimeout(() => {
                videoWithSound.pause();
                
                // Remover feedback visual
                frameBtn.style.background = '';
                frameBtn.style.borderColor = '';
                frameBtn.style.color = '';
            }, realTime * 1000);
        }

        function frameBackward() {
            const videoWithSound = document.querySelector('.video-item.has-sound video');
            if (!videoWithSound) return;
            
            // Limpar timeout anterior se existir
            if (frameBackwardTimeout) {
                clearTimeout(frameBackwardTimeout);
            }
            
            // Voltar 15 frames instantaneamente
            const frameTime = 15 / 30; // 0.5 segundos
            videoWithSound.currentTime = Math.max(0, videoWithSound.currentTime - frameTime);
            
            // Tocar esses 15 frames em c√¢mera lenta 0.4x (revis√£o)
            videoWithSound.playbackRate = 0.4;
            videoWithSound.play();
            
            const realTime = frameTime / 0.4; // tempo real para tocar em 0.4x
            
            // Feedback visual no bot√£o
            const frameBtn = document.getElementById('frameBackBtn');
            frameBtn.style.background = 'rgba(255, 152, 0, 0.95)';
            frameBtn.style.borderColor = '#ff9800';
            frameBtn.style.color = 'white';
            
            // Depois de tocar os 15 frames, pausar
            frameBackwardTimeout = setTimeout(() => {
                videoWithSound.pause();
                
                // Remover feedback visual
                frameBtn.style.background = '';
                frameBtn.style.borderColor = '';
                frameBtn.style.color = '';
            }, realTime * 1000);
        }

        // Slow Replay Function
        function slowReplay() {
            // Find video with sound
            const videoWithSound = document.querySelector('.video-item.has-sound video');
            
            if (!videoWithSound) return;
            
            // Clear any existing timeout
            if (slowReplayTimeout) {
                clearTimeout(slowReplayTimeout);
            }
            
            // Save current speed
            previousSpeed = currentSpeed;
            
            // Go back 5 seconds
            videoWithSound.currentTime = Math.max(0, videoWithSound.currentTime - 5);
            
            // Set speed to 0.5x
            videoWithSound.playbackRate = 0.5;
            
            // Visual feedback
            const replayBtn = document.getElementById('replayBtn');
            replayBtn.classList.add('active');
            
            // After 5 seconds, restore original speed
            slowReplayTimeout = setTimeout(() => {
                videoWithSound.playbackRate = previousSpeed;
                replayBtn.classList.remove('active');
                slowReplayTimeout = null;
            }, 5000);
        }

        // Mini Fullscreen Functions
        function openMiniFullscreen() {
            // Find video with sound
            const videoWithSound = document.querySelector('.video-item.has-sound video');
            
            if (!videoWithSound) return;
            
            // Get video source
            const videoSrc = videoWithSound.src;
            const currentTime = videoWithSound.currentTime;
            const currentPlaybackRate = videoWithSound.playbackRate;
            
            // Set up mini fullscreen video
            const miniVideo = document.getElementById('miniFullscreenVideo');
            miniVideo.src = videoSrc;
            miniVideo.currentTime = currentTime;
            miniVideo.playbackRate = currentPlaybackRate;
            miniVideo.muted = false;
            
            // Update speed buttons
            document.querySelectorAll('.mini-control-btn[id^="mini-speed"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`mini-speed-${currentPlaybackRate}`).classList.add('active');
            
            // Pause original video
            videoWithSound.pause();
            
            // Show mini fullscreen
            document.getElementById('miniFullscreenOverlay').classList.add('active');
            document.getElementById('miniFullscreen').classList.add('active');
            miniVideo.play();
            
            miniFullscreenActive = true;
            currentFullscreenVideo = videoWithSound;
        }

        // Adicionar evento de clique no v√≠deo fullscreen para pause/play
        document.getElementById('miniFullscreenVideo').addEventListener('click', function(e) {
            e.stopPropagation(); // Impede que feche o fullscreen
            toggleMiniPause(); // Usa a fun√ß√£o que j√° existe
        });

        function closeMiniFullscreen() {
            if (!miniFullscreenActive) return;
            
            const miniVideo = document.getElementById('miniFullscreenVideo');
            const currentTime = miniVideo.currentTime;
            
            // Clear any active replay timeout
            if (miniSlowReplayTimeout) {
                clearTimeout(miniSlowReplayTimeout);
                miniSlowReplayTimeout = null;
            }
            
            // Update original video time
            if (currentFullscreenVideo) {
                currentFullscreenVideo.currentTime = currentTime;
                currentFullscreenVideo.play();
            }
            
            // Hide mini fullscreen
            document.getElementById('miniFullscreenOverlay').classList.remove('active');
            document.getElementById('miniFullscreen').classList.remove('active');
            
            // Stop and clear mini video
            miniVideo.pause();
            miniVideo.src = '';
            
            // Reset pause button
            document.getElementById('miniPauseBtn').textContent = '‚è∏';
            document.getElementById('miniPauseBtn').classList.remove('paused');
            
            miniFullscreenActive = false;
            currentFullscreenVideo = null;
        }

        // Mini Fullscreen Control Functions
        function setMiniSpeed(speed) {
            const miniVideo = document.getElementById('miniFullscreenVideo');
            miniVideo.playbackRate = speed;
            
            // Update button states
            document.querySelectorAll('.mini-control-btn[id^="mini-speed"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`mini-speed-${speed}`).classList.add('active');
        }

        function toggleMiniPause() {
            const miniVideo = document.getElementById('miniFullscreenVideo');
            const pauseBtn = document.getElementById('miniPauseBtn');
            
            if (miniVideo.paused) {
                miniVideo.play();
                pauseBtn.textContent = '‚è∏';
                pauseBtn.classList.remove('paused');
            } else {
                miniVideo.pause();
                pauseBtn.textContent = '‚ñ∂';
                pauseBtn.classList.add('paused');
            }
        }

        function miniSlowReplay() {
            const miniVideo = document.getElementById('miniFullscreenVideo');
            
            // Clear any existing timeout
            if (miniSlowReplayTimeout) {
                clearTimeout(miniSlowReplayTimeout);
            }
            
            // Save current speed
            const previousSpeed = miniVideo.playbackRate;
            
            // Go back 5 seconds
            miniVideo.currentTime = Math.max(0, miniVideo.currentTime - 5);
            
            // Set speed to 0.5x
            miniVideo.playbackRate = 0.5;
            
            // Visual feedback
            const replayBtn = document.getElementById('miniReplayBtn');
            replayBtn.classList.add('active');
            
            // Update speed button
            document.querySelectorAll('.mini-control-btn[id^="mini-speed"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('mini-speed-0.5').classList.add('active');
            
            // After 5 seconds, restore original speed
            miniSlowReplayTimeout = setTimeout(() => {
                miniVideo.playbackRate = previousSpeed;
                replayBtn.classList.remove('active');
                
                // Update speed button back
                document.querySelectorAll('.mini-control-btn[id^="mini-speed"]').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`mini-speed-${previousSpeed}`).classList.add('active');
                
                miniSlowReplayTimeout = null;
            }, 5000);
        }

        function miniGoToNext() {
            // Close mini fullscreen first
            const currentTime = document.getElementById('miniFullscreenVideo').currentTime;
            closeMiniFullscreen();
            
            // Wait a bit for animation
            setTimeout(() => {
                goToNextVideo();
                
                // Reopen mini fullscreen with new video
                setTimeout(() => {
                    openMiniFullscreen();
                }, 800);
            }, 300);
        }

        // Close mini fullscreen with ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && miniFullscreenActive) {
                closeMiniFullscreen();
            }
        });

        // Camera Recording Variables
        let cameraStream;
        let mediaRecorder;
        let recordedChunks = [];
        let isRecordingCamera = false;
        let recordingStartTime;
        let recordingTimerInterval;
        let isCameraPaused = false;

        // Send to Recorder (Now opens camera in same page)
        function sendToRecorder() {
            // Auto-collapse floating buttons (except fullscreen)
            collapseSpeedControls();

            // Find video with sound in the normal gallery
            const videoWithSoundNormal = document.querySelector('#galleryNormal .video-item.has-sound');
            
            if (!videoWithSoundNormal) {
                alert('Nenhum v√≠deo com som selecionado! Clique em um v√≠deo para ligar o som primeiro.');
                return;
            }
            
            // Get the video ID
            const videoId = videoWithSoundNormal.dataset.id;
            
            // Pause and mute the video in normal gallery
            const videoElNormal = videoWithSoundNormal.querySelector('video');
            if (videoElNormal) {
                videoElNormal.pause();
                videoElNormal.muted = true;
            }
            
            // Activate camera mode
            document.body.classList.add('camera-mode-active');
            document.getElementById('cameraContainer').classList.add('active');
            
            // Wait a bit for the mode to activate, then find and activate sound on the same video in camera gallery
            setTimeout(() => {
                const videoInCameraMode = document.querySelector(`#gallery .video-item[data-id="${videoId}"]`);
                if (videoInCameraMode) {
                    const videoEl = videoInCameraMode.querySelector('video');
                    if (videoEl) {
                        // Unmute this video
                        videoEl.muted = false;
                        videoInCameraMode.classList.add('has-sound');
                        
                        // Make sure it plays
                        videoEl.play().catch(err => {
                            console.log('Play error:', err);
                        });
                    }
                }
                
                // Scroll to show both
                document.querySelector('.side-by-side-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // Camera Functions
        async function startCameraRecording() {
            try {
                console.log('Requesting camera access...');
                
                // Request camera permission - BACK CAMERA with ULTRAWIDE
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: { exact: 'environment' }, // C√¢mera traseira
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        aspectRatio: { ideal: 16/9 }
                    }, 
                    audio: true 
                });
                
                console.log('Camera access granted!');
                
                const cameraVideo = document.getElementById('cameraVideo');
                const placeholder = document.getElementById('cameraPlaceholder');
                
                // Set the stream
                cameraVideo.srcObject = cameraStream;
                
                // Force muted to allow autoplay
                cameraVideo.muted = true;
                cameraVideo.volume = 0;
                
                console.log('Stream set, showing video...');
                
                // Show video with class
                cameraVideo.classList.add('active');
                
                // Wait a bit for the stream to start
                setTimeout(async () => {
                    try {
                        await cameraVideo.play();
                        console.log('‚úì Camera preview playing!');
                    } catch (e) {
                        console.error('Play error:', e);
                    }
                }, 300);
                
                document.getElementById('startCameraBtn').disabled = true;
                document.getElementById('recordCameraBtn').disabled = false;
                document.getElementById('pauseCameraBtn').disabled = false;
                document.getElementById('startCameraBtn').textContent = '‚úì C√¢mera Ativa';
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                
                // Se falhar com exact, tenta sem exact
                try {
                    console.log('Trying without exact constraint...');
                    cameraStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }, 
                        audio: true 
                    });
                    
                    const cameraVideo = document.getElementById('cameraVideo');
                    cameraVideo.srcObject = cameraStream;
                    cameraVideo.muted = true;
                    cameraVideo.classList.add('active');
                    
                    setTimeout(async () => {
                        await cameraVideo.play();
                        console.log('‚úì Camera started with fallback!');
                    }, 300);
                    
                    document.getElementById('startCameraBtn').disabled = true;
                    document.getElementById('recordCameraBtn').disabled = false;
                    document.getElementById('pauseCameraBtn').disabled = false;
                    document.getElementById('startCameraBtn').textContent = '‚úì C√¢mera Ativa';
                    
                } catch (fallbackError) {
                    console.error('Fallback also failed:', fallbackError);
                    alert('Erro ao acessar c√¢mera traseira: ' + fallbackError.message);
                }
            }
        }

        // Fun√ß√£o para gerar n√∫mero aleat√≥rio de 4 d√≠gitos que n√£o termina em 1, 2 ou 3
        function generateSafeRandomNumber() {
            let number;
            do {
                // Gera n√∫mero entre 1000 e 9999
                number = Math.floor(Math.random() * 9000) + 1000;
            } while (number % 10 === 1 || number % 10 === 2 || number % 10 === 3);
            return number;
        }

        function toggleRecording() {
            if (isRecordingCamera) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!cameraStream) return;
            
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(cameraStream, {
                mimeType: 'video/webm;codecs=vp9'
            });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                console.log('üé¨ Grava√ß√£o parada! Processando...');
                console.log('üìä Chunks gravados:', recordedChunks.length);
                
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                
                console.log('‚úÖ Blob criado:', blob.size, 'bytes');
                console.log('‚úÖ URL criada:', url);
                
                // Armazenar blob globalmente para download posterior
                window.recordedBlob = blob;
                window.recordedUrl = url;
                
                // Mostrar preview
                const previewContainer = document.getElementById('recordingPreviewContainer');
                const previewVideo = document.getElementById('previewVideo');
                
                console.log('üì∫ Elementos encontrados:', {
                    container: !!previewContainer,
                    video: !!previewVideo
                });
                
                if (!previewContainer || !previewVideo) {
                    console.error('‚ùå Elementos n√£o encontrados!');
                    alert('Erro: Elementos do preview n√£o encontrados!');
                    return;
                }
                
                // Event listeners para debug
                previewVideo.onloadeddata = () => {
                    console.log('‚úÖ V√≠deo carregado com sucesso!');
                };
                
                previewVideo.onerror = (e) => {
                    console.error('‚ùå Erro ao carregar v√≠deo:', e);
                    alert('Erro ao carregar preview do v√≠deo!');
                };
                
                // Configurar v√≠deo
                previewVideo.src = url;
                previewVideo.muted = false;
                previewVideo.controls = true;
                
                // Preencher nome padr√£o do arquivo com novo formato
                const randomNumber = generateSafeRandomNumber();
                const defaultName = `üü£ABRIR_TREINO_${randomNumber}`;
                document.getElementById('videoNameInput').value = defaultName;
                
                // Mostrar container ANTES de carregar
                previewContainer.style.display = 'block';
                console.log('‚úÖ Container exibido');
                
                // Tentar dar play automaticamente ap√≥s carregar
                previewVideo.oncanplay = () => {
                    console.log('‚úÖ V√≠deo pronto para tocar');
                };
                
                // Scroll suave at√© o preview
                setTimeout(() => {
                    previewContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    console.log('üìç Scroll executado');
                }, 500);
            };

            mediaRecorder.start();
            isRecordingCamera = true;
            
            document.getElementById('recordCameraBtn').textContent = '‚èπ Parar';
            document.getElementById('recordCameraBtn').classList.add('recording');
            document.getElementById('recordingIndicatorCamera').classList.add('active');
            
            // Start timer
            recordingStartTime = Date.now();
            updateRecordingTimer();
            recordingTimerInterval = setInterval(updateRecordingTimer, 1000);
        }

        function stopRecording() {
            if (mediaRecorder && isRecordingCamera) {
                mediaRecorder.stop();
                isRecordingCamera = false;
                
                document.getElementById('recordCameraBtn').textContent = '‚è∫ Gravar';
                document.getElementById('recordCameraBtn').classList.remove('recording');
                document.getElementById('recordingIndicatorCamera').classList.remove('active');
                
                // Stop timer
                clearInterval(recordingTimerInterval);
                document.getElementById('recordingTimer').classList.remove('active');
                document.getElementById('recordingTimer').textContent = '00:00';
            }
        }

        function updateRecordingTimer() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            
            const timerEl = document.getElementById('recordingTimer');
            timerEl.textContent = `${minutes}:${seconds}`;
            timerEl.classList.add('active');
        }

        function downloadPreview() {
            if (!window.recordedBlob || !window.recordedUrl) {
                alert('Nenhuma grava√ß√£o dispon√≠vel para download!');
                return;
            }
            
            // Pegar o nome editado pelo usu√°rio
            const videoNameInput = document.getElementById('videoNameInput');
            let fileName = videoNameInput.value.trim();
            
            // Valida√ß√£o: se estiver vazio, usar nome padr√£o
            if (!fileName) {
                const randomNumber = generateSafeRandomNumber();
                fileName = `üü£ABRIR_TREINO_${randomNumber}`;
                videoNameInput.value = fileName;
            }
            
            // Remover extens√£o se o usu√°rio digitou
            fileName = fileName.replace(/\.(webm|mp4|mov)$/i, '');
            
            // Adicionar extens√£o
            const fullFileName = `${fileName}.webm`;
            
            console.log('üì• Tentando download com nome:', fullFileName);
            
            try {
                // M√©todo 1: Criar link de download (mais compat√≠vel)
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = window.recordedUrl;
                a.download = fullFileName;
                
                // Adicionar ao DOM, clicar e remover
                document.body.appendChild(a);
                a.click();
                
                // Aguardar um pouco antes de remover
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(window.recordedUrl);
                }, 100);
                
                console.log('‚úÖ Download iniciado');
                
                // Mensagem personalizada com instru√ß√µes
                setTimeout(() => {
                    alert('Grava√ß√£o salva com sucesso!\n\nüìù Salve com emojis na frente ü•éü•äü©∏üü£\n\nüìÇ E mova para Armazenamento > Movies > Abrir treino\n\nüí° Se o nome n√£o ficou correto, renomeie manualmente para: ' + fullFileName);
                }, 200);
                
            } catch (error) {
                console.error('‚ùå Erro no download:', error);
                alert('Erro ao baixar v√≠deo. Tente novamente ou use outro navegador.');
            }
        }

        function copyFileName() {
            const videoNameInput = document.getElementById('videoNameInput');
            let fileName = videoNameInput.value.trim();
            
            if (!fileName) {
                alert('Digite um nome primeiro!');
                return;
            }
            
            // Remover extens√£o se tiver
            fileName = fileName.replace(/\.(webm|mp4|mov)$/i, '');
            const fullFileName = `${fileName}.webm`;
            
            // Copiar para clipboard
            navigator.clipboard.writeText(fullFileName).then(() => {
                // Feedback visual
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1000);
                
                console.log('üìã Nome copiado:', fullFileName);
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('Erro ao copiar. Nome: ' + fullFileName);
            });
        }

        function toggleCameraPause() {
            const cameraVideo = document.getElementById('cameraVideo');
            const pauseBtn = document.getElementById('pauseCameraBtn');
            
            if (isCameraPaused) {
                // Retomar
                cameraVideo.play();
                pauseBtn.textContent = '‚è∏ Pausar';
                isCameraPaused = false;
            } else {
                // Pausar
                cameraVideo.pause();
                pauseBtn.textContent = '‚ñ∂ Retomar';
                isCameraPaused = true;
            }
        }

        function toggleVideoPlayPause() {
            // Find the video with sound in camera mode gallery
            const videoWithSound = document.querySelector('#gallery .video-item.has-sound video');
            const playPauseBtn = document.getElementById('videoPlayPauseBtn');
            
            if (!videoWithSound) {
                alert('Nenhum v√≠deo ativo!');
                return;
            }
            
            if (videoWithSound.paused) {
                // Play and unmute
                videoWithSound.play();
                videoWithSound.muted = false;
                playPauseBtn.textContent = '‚è∏ Pausar V√≠deo';
            } else {
                // Pause and mute
                videoWithSound.pause();
                videoWithSound.muted = true;
                playPauseBtn.textContent = '‚ñ∂ Retomar V√≠deo';
            }
        }

        function closeCamera() {
            // Stop recording if active
            if (isRecordingCamera) {
                stopRecording();
            }
            
            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                const cameraVideo = document.getElementById('cameraVideo');
                cameraVideo.srcObject = null;
                cameraVideo.classList.remove('active');
            }
            
            // Deactivate camera mode
            document.body.classList.remove('camera-mode-active');
            document.getElementById('cameraContainer').classList.remove('active');
            
            // Hide preview
            document.getElementById('recordingPreviewContainer').style.display = 'none';
            
            // Reset buttons
            document.getElementById('startCameraBtn').disabled = false;
            document.getElementById('startCameraBtn').textContent = 'üì∑ Iniciar C√¢mera';
            document.getElementById('recordCameraBtn').disabled = true;
            document.getElementById('recordCameraBtn').textContent = '‚è∫ Gravar';
            document.getElementById('pauseCameraBtn').disabled = true;
            document.getElementById('pauseCameraBtn').textContent = '‚è∏ Pausar';
            document.getElementById('videoPlayPauseBtn').textContent = '‚è∏ Pausar V√≠deo';
            isCameraPaused = false;
        }
    </script>
</body>
</html>
